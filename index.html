<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Organizator Zadataka, Bilje≈°ki i Podsjetnika</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Externe biblioteke -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://smtpjs.com/v3/smtp.js"></script>
  
  <!-- Canvas Confetti za vatromet -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* Globalni stilovi */
    :root {
      --primary-color: #6B46C1;
      --primary-hover: #553C9A;
      --secondary-color: #1a73e8;
      --secondary-hover: #1557b0;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --light-gray: #f8f9fa;
      --dark-gray: #343a40;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 6px 8px rgba(0, 0, 0, 0.15);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Arial', sans-serif;
      display: grid;
      grid-template-columns: 1fr 3fr;
      gap: 20px;
      padding: 20px;
      background: #f0f2f5;
      margin: 0;
      min-height: 100vh;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Sidebar stilovi */
    .sidebar {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .sidebar button {
      width: 100%;
      padding: 12px;
      margin: 0;
      border: none;
      border-radius: 8px;
      background: var(--primary-color);
      color: white;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      font-size: 16px;
    }
    
    .sidebar button i {
      width: 20px;
      text-align: center;
    }
    
    .sidebar button:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    #scheduleButton {
      background: var(--primary-color);
      margin-top: auto;
    }
    
    #scheduleButton:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    /* Kalendar stilovi */
    .calendar {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .calendar-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--dark-gray);
      transition: color 0.3s ease;
    }
    
    .header-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    #darkModeToggle {
      background: transparent;
      border: none;
      color: var(--primary-color);
      font-size: 1.2rem;
      cursor: pointer;
      transition: transform 0.3s ease, color 0.3s ease;
      padding: 8px;
    }
    
    #darkModeToggle:hover {
      transform: rotate(20deg);
    }
    
    .calendar-header button {
      background: var(--primary-color);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .calendar-header button:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    th, td {
      padding: 15px;
      border: 1px solid #e9ecef;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }
    
    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
    }
    
    td {
      background-color: white;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    
    td:hover {
      background-color: var(--light-gray);
      transform: scale(1.02);
    }

    .has-entry {
      background-color: #e3f2fd !important;
      position: relative;
    }
    
    .has-entry::after {
      content: '';
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 6px;
      background-color: var(--primary-color);
      border-radius: 50%;
    }

    /* Dugmad ispod kalendara */
    .calendar-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .calendar-actions button {
      padding: 10px 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      flex: 1;
    }
    
    .calendar-actions button:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    /* Modal i overlay stilovi */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      z-index: 1000;
      max-width: 90%;
      max-height: 90vh;
      overflow: auto;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
      width: 500px;
      resize: both;
      overflow: auto;
    }
    
    .modal.maximized {
      width: 95% !important;
      height: 95% !important;
      max-width: none;
      max-height: none;
      resize: none;
    }
    
    .modal.show {
      display: block;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    
    .modal h2 {
      margin-top: 0;
      color: var(--primary-color);
      border-bottom: 2px solid var(--light-gray);
      padding-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-controls {
      display: flex;
      gap: 5px;
    }
    
    .modal-controls button {
      background: transparent;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 5px;
      border-radius: 4px;
      transition: var(--transition);
    }
    
    .modal-controls button:hover {
      background: var(--light-gray);
    }
    
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .overlay.show {
      display: block;
      opacity: 1;
    }

    /* Form elementi */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark-gray);
      transition: color 0.3s ease;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 16px;
      transition: var(--transition);
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.2);
    }
    
    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }
    
    .form-actions button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }
    
    .form-actions button:first-child {
      background: var(--primary-color);
      color: white;
    }
    
    .form-actions button:first-child:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    .form-actions button:last-child {
      background: white;
      color: var(--dark-gray);
      border: 1px solid #e9ecef;
    }
    
    .form-actions button:last-child:hover {
      background: var(--light-gray);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    /* PDF editor stilovi */
    #pdfImportModal {
      width: 90%;
      height: 90%;
    }
    
    #pdfDisplay {
      position: relative;
      border: 1px solid #e9ecef;
      height: 500px;
      margin: 20px auto;
      background-color: #f3f3f3;
      overflow: auto;
      border-radius: 8px;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    
    .pdf-page {
      margin: 10px auto;
      border: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      background: white;
    }
    
    .note {
      position: absolute;
      padding: 10px;
      border: 1px solid #e9ecef;
      cursor: move;
      resize: none;
      min-width: 120px;
      min-height: 60px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    
    .note:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.2);
    }
    
    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .toolbar input[type="file"] {
      display: none;
    }
    
    .toolbar label {
      padding: 10px 15px;
      background: var(--primary-color);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .toolbar label:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    .toolbar select {
      padding: 10px;
      border-radius: 8px;
      border: 2px solid #e9ecef;
      cursor: pointer;
    }
    
    .toolbar button {
      padding: 10px 15px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .toolbar button:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    /* Novi stilovi za pro≈°ireni Import modal */
    .import-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .import-actions button {
      padding: 10px 15px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .import-actions button:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    .format-selector {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .format-selector label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }
    
    .audio-controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .audio-controls button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
      background: var(--primary-color);
      color: white;
    }
    
    .audio-controls button:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-2px);
    }
    
    .audio-controls button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .audio-progress {
      width: 100%;
      margin-top: 10px;
    }
    
    .audio-progress-bar {
      width: 100%;
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .audio-progress-fill {
      height: 100%;
      background-color: var(--primary-color);
      width: 0%;
      transition: width 0.1s ease;
    }
    
    .audio-status {
      margin-top: 10px;
      font-size: 14px;
      color: var(--dark-gray);
    }

    /* Detalji datuma */
    #dateDetailsModal {
      width: 600px;
      max-height: 80vh;
    }
    
    #detailsContent {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    
    .entry-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-bottom: 1px solid #e9ecef;
      transition: var(--transition);
    }
    
    .entry-item:hover {
      background-color: var(--light-gray);
    }
    
    .entry-item .entry-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    
    .entry-item .entry-actions {
      display: flex;
      gap: 5px;
    }
    
    .entry-item button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    
    .entry-item button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .entry-item button.edit-btn {
      background: var(--secondary-color);
      color: white;
    }
    
    .entry-item button.edit-btn:hover:not(:disabled) {
      background: var(--secondary-hover);
      transform: translateY(-2px);
    }
    
    .entry-item button.delete-btn {
      background: var(--danger-color);
      color: white;
    }
    
    .entry-item button.delete-btn:hover:not(:disabled) {
      background: #c82333;
      transform: translateY(-2px);
    }
    
    .entry-item button.connect-btn {
      background: var(--success-color);
      color: white;
    }
    
    .entry-item button.connect-btn:hover:not(:disabled) {
      background: #218838;
      transform: translateY(-2px);
    }

    /* Reminder modal stilovi */
    #reminderModal .container {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      width: 100%;
      transition: background-color 0.3s ease;
    }
    
    #reminderModal h1 {
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 2rem;
      font-size: 1.8rem;
    }
    
    #reminderModal button[type="submit"] {
      width: 100%;
      padding: 14px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 10px;
    }
    
    #reminderModal button[type="submit"]:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    #statusMessage {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      transition: var(--transition);
    }
    
    .success {
      background-color: #e6f4ea;
      color: #137333;
    }
    
    .error {
      background-color: #fce8e6;
      color: #c5221f;
    }

    /* Animacija vatrometa */
    .firework-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2000;
    }

    /* Dark Mode stilovi */
    body.dark-mode {
      background: #121212;
      color: #e0e0e0;
    }

    body.dark-mode .sidebar,
    body.dark-mode .calendar,
    body.dark-mode .modal,
    body.dark-mode #reminderModal .container {
      background: #1e1e1e;
      color: #e0e0e0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    body.dark-mode th {
      background-color: #3700B3;
    }

    body.dark-mode td {
      background-color: #2d2d2d;
      border-color: #444;
    }

    body.dark-mode td:hover {
      background-color: #3d3d3d;
    }

    body.dark-mode .has-entry {
      background-color: #0d47a1 !important;
    }

    body.dark-mode .form-group input,
    body.dark-mode .form-group textarea,
    body.dark-mode .form-group select {
      background-color: #2d2d2d;
      border-color: #444;
      color: #e0e0e0;
    }

    body.dark-mode .entry-item:hover {
      background-color: #2d2d2d;
    }

    body.dark-mode #pdfDisplay {
      background-color: #2d2d2d;
      border-color: #444;
    }

    body.dark-mode .note {
      background-color: #333;
      border-color: #555;
      color: #e0e0e0;
    }

    body.dark-mode #darkModeToggle {
      color: #bb86fc;
    }

    body.dark-mode .form-actions button:last-child {
      background: #2d2d2d;
      color: #e0e0e0;
      border-color: #444;
    }

    body.dark-mode .form-actions button:last-child:hover {
      background: #3d3d3d;
    }

    body.dark-mode .modal h2,
    body.dark-mode .form-group label {
      color: #e0e0e0;
    }

    /* Habit Tracker stilovi */
    .habit-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .habit-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .day-box {
      padding: 8px;
      text-align: center;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .day-box:hover {
      transform: scale(1.05);
    }

    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    /* MODERN HABIT TRACKER STILOVI */
    .modern-habit-tracker {
      background: var(--background);
      color: var(--text-color);
      padding: 20px;
      border-radius: 12px;
      max-width: 1200px;
      margin: 0 auto;
      transition: var(--transition);
    }

    .modern-habit-tracker .charts-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .modern-habit-tracker .charts-container {
        grid-template-columns: 1fr;
      }
    }

    .modern-habit-tracker .progress-card {
      background: var(--light-gray);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
    }

    .modern-habit-tracker .progress-card h3 {
      margin-bottom: 15px;
      color: var(--dark-gray);
    }

    .modern-habit-tracker .circular-progress {
      width: 120px;
      height: 120px;
      margin: 15px auto;
      border-radius: 50%;
      background: conic-gradient(var(--primary-color) var(--progress), var(--light-gray) 0);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .modern-habit-tracker .circular-progress::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg,
          transparent 25%,
          rgba(255,255,255,0.2) 50%,
          transparent 75%
      );
      background-size: 200% 200%;
      animation: shine 2s infinite linear;
    }

    @keyframes shine {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .modern-habit-tracker .progress-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--dark-gray);
      z-index: 1;
    }

    .modern-habit-tracker .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      align-items: center;
      flex-wrap: wrap;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--light-gray);
    }

    .modern-habit-tracker select, 
    .modern-habit-tracker input[type="text"] {
      padding: 10px 15px;
      border: 2px solid var(--light-gray);
      border-radius: 8px;
      font-size: 14px;
      background: var(--light-gray);
      color: var(--text-color);
      transition: var(--transition);
    }

    .modern-habit-tracker select:focus, 
    .modern-habit-tracker input[type="text"]:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
    }

    .modern-habit-tracker .add-btn {
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      box-shadow: var(--shadow);
      font-weight: 600;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    .modern-habit-tracker .add-btn:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: var(--shadow-hover);
    }

    .modern-habit-tracker .delete-btn {
      background: var(--danger-color);
      padding: 5px 10px;
      margin-left: 10px;
      font-size: 12px;
    }

    .modern-habit-tracker .delete-btn:hover {
      background: #d32f2f;
    }

    .modern-habit-tracker table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      border: 2px solid var(--light-gray);
      border-radius: 8px;
      overflow: hidden;
    }

    .modern-habit-tracker th, 
    .modern-habit-tracker td {
      padding: 10px;
      text-align: center;
      border: 1px solid var(--light-gray);
      transition: var(--transition);
    }

    .modern-habit-tracker .task-name {
      text-align: left;
      padding-left: 15px;
      background: var(--light-gray);
      font-weight: 700;
      min-width: 200px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      position: relative;
    }

    .modern-habit-tracker .task-name::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 60%;
      background: var(--primary-color);
      border-radius: 2px;
    }

    .modern-habit-tracker .date-header {
      background: var(--primary-color);
      color: white;
      font-weight: 500;
      min-width: 40px;
    }

    .modern-habit-tracker input[type="checkbox"] {
      width: 20px;
      height: 20px;
      border: 2px solid #64B5F6;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      appearance: none;
      -webkit-appearance: none;
      position: relative;
      transform: scale(1.2);
      background-color: var(--background);
    }

    .modern-habit-tracker input[type="checkbox"]:hover {
      transform: scale(1.3);
    }

    .modern-habit-tracker input[type="checkbox"]:checked {
      background: var(--primary-color);
      border-color: var(--primary-color);
    }

    .modern-habit-tracker input[type="checkbox"]:checked::after {
      content: '\f00c';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: white;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
    }

    .modern-habit-tracker .stats-container {
      padding: 5px;
    }

    .modern-habit-tracker .progress-bar {
      height: 20px;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      transition: width 0.3s ease;
      margin-bottom: 5px;
      position: relative;
      overflow: hidden;
    }

    .modern-habit-tracker .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg,
          transparent,
          rgba(255,255,255,0.3),
          transparent
      );
      animation: shine 1.5s infinite;
    }

    .modern-habit-tracker .stats-text {
      font-size: 12px;
      color: var(--dark-gray);
    }

    .modern-habit-tracker .greeting {
      font-size: 1.2rem;
      margin-bottom: 20px;
      font-weight: 500;
      color: var(--primary-color);
    }

    .modern-habit-tracker .streak-counter {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--primary-color);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modern-habit-tracker .theme-picker {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
    }

    .modern-habit-tracker .theme-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid white;
      cursor: pointer;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      background: var(--primary-color);
    }

    .modern-habit-tracker .theme-btn:hover {
      background: var(--primary-hover);
    }

    /* Mobilni prikaz za Modern Habit Tracker */
    @media (max-width: 768px) {
      .modern-habit-tracker {
        padding: 10px;
        overflow-x: auto;
      }
      
      .modern-habit-tracker table {
        min-width: 600px;
      }
      
      .modern-habit-tracker input[type="checkbox"] {
        transform: scale(1.5);
        margin: 0 5px;
      }
      
      .modern-habit-tracker .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .modern-habit-tracker .streak-counter {
        position: static;
        margin-bottom: 15px;
        width: fit-content;
      }
    }
    
    /* Merge PDF modal stilovi */
    .merge-pdf-container {
      margin: 20px 0;
      padding: 15px;
      border: 2px dashed var(--primary-color);
      border-radius: 8px;
      background-color: rgba(107, 70, 193, 0.05);
    }
    
    .merge-file-list {
      margin: 15px 0;
    }
    
    .merge-file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      background: white;
      border-radius: 6px;
      margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .merge-file-item .file-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .merge-file-item .file-actions {
      display: flex;
      gap: 5px;
    }
    
    .merge-file-item button {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .merge-file-item .remove-btn {
      background: var(--danger-color);
      color: white;
    }
    
    .merge-file-item .remove-btn:hover {
      background: #c82333;
    }
    
    .merge-status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }
    
    .merge-status.success {
      background-color: #e6f4ea;
      color: #137333;
    }
    
    .merge-status.error {
      background-color: #fce8e6;
      color: #c5221f;
    }
    
    /* Download PDF button */
    .download-pdf-btn {
      background: var(--success-color) !important;
      margin-top: 10px;
    }
    
    .download-pdf-btn:hover {
      background: #218838 !important;
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <button onclick="showCalendar()">
      <i class="fas fa-calendar-alt"></i> Kalendar
    </button>
    <button onclick="showTaskModal()">
      <i class="fas fa-tasks"></i> Zadatci
    </button>
    <button onclick="showNotesModal()">
      <i class="fas fa-sticky-note"></i> Bilje≈°ke
    </button>
    <button onclick="showPdfImportModal()">
      <i class="fas fa-file-import"></i> Import
    </button>
    <button onclick="showModernHabitTracker()">
      <i class="fas fa-calendar-check"></i> Habit tracker
    </button>
    <!-- DODANO: Dugme Podsjetnik -->
    <button onclick="showReminderModal()">
      <i class="fas fa-bell"></i> Podsjetnik
    </button>
    <button id="scheduleButton" onclick="showReminderModal()">
      <i class="fas fa-bell"></i> Zaka≈æi
    </button>
  </div>

  <!-- KALENDAR -->
  <div class="calendar">
    <div class="calendar-header">
      <button onclick="prevMonth()">
        <i class="fas fa-chevron-left"></i> Prev
      </button>
      <h2 id="monthYear"></h2>
      <div class="header-controls">
        <button id="darkModeToggle" onclick="toggleDarkMode()">
          <i class="fas fa-moon"></i>
        </button>
        <button onclick="nextMonth()">
          Next <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Pon</th>
          <th>Uto</th>
          <th>Sri</th>
          <th>ƒået</th>
          <th>Pet</th>
          <th>Sub</th>
          <th>Ned</th>
        </tr>
      </thead>
      <tbody id="calendarBody"></tbody>
    </table>
    <div class="calendar-actions">
      <button id="pdfButton" onclick="exportMonthPDF(false)">
        <i class="fas fa-file-pdf"></i> PDF
      </button>
      <button id="clearAllButton" onclick="clearAllMonth()">
        <i class="fas fa-trash-alt"></i> Clear All
      </button>
    </div>
  </div>

  <!-- Overlay (koristi se za sve modale) -->
  <div id="overlay" class="overlay"></div>

  <!-- Modal za zadatke -->
  <div id="taskModal" class="modal">
    <h2><i class="fas fa-tasks"></i> Dodaj Zadatak</h2>
    <div class="form-group">
      <label for="taskTitle">Naslov zadatka:</label>
      <input type="text" id="taskTitle" placeholder="Unesite zadatak">
    </div>
    <div class="form-group">
      <label for="taskDate">Datum i vrijeme:</label>
      <input type="datetime-local" id="taskDate">
    </div>
    <div class="form-actions">
      <button onclick="saveTask()">
        <i class="fas fa-save"></i> Dodaj
      </button>
      <button onclick="closeModals()">
        <i class="fas fa-times"></i> Zatvori
      </button>
    </div>
  </div>

  <!-- Modal za bilje≈°ke -->
  <div id="notesModal" class="modal">
    <h2><i class="fas fa-sticky-note"></i> Dodaj Bilje≈°ku</h2>
    <div class="form-group">
      <label for="noteText">Bilje≈°ka:</label>
      <textarea id="noteText" rows="5" placeholder="Unesite bilje≈°ku"></textarea>
    </div>
    <div class="form-group">
      <label for="noteDate">Datum i vrijeme:</label>
      <input type="datetime-local" id="noteDate">
    </div>
    <div class="form-actions">
      <button onclick="addNote()">
        <i class="fas fa-save"></i> Dodaj
      </button>
      <button onclick="closeModals()">
        <i class="fas fa-times"></i> Zatvori
      </button>
    </div>
  </div>

  <!-- Modal za PDF import i ureƒëivanje -->
  <div id="pdfImportModal" class="modal">
    <h2>
      <i class="fas fa-file-pdf"></i> Uredi PDF
      <div class="modal-controls">
        <button onclick="maximizeModal('pdfImportModal')" title="Maksimiziraj">
          <i class="fas fa-expand"></i>
        </button>
        <button onclick="minimizeModal('pdfImportModal')" title="Minimiziraj">
          <i class="fas fa-compress"></i>
        </button>
        <button onclick="closeModals()" title="Zatvori">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </h2>
    <div class="toolbar">
      <input type="file" id="pdfFileInput" accept="application/pdf">
      <label for="pdfFileInput">
        <i class="fas fa-folder-open"></i> Odaberi PDF
      </label>
      <select id="noteColor">
        <option value="yellow">≈Ωuta (obiƒçna)</option>
        <option value="red">Crvena (va≈æno)</option>
        <option value="green">Zelena (komentar)</option>
      </select>
      <button onclick="addNoteToPdf()">
        <i class="fas fa-plus"></i> Dodaj napomenu
      </button>
      <button onclick="saveEditedPdf()">
        <i class="fas fa-save"></i> Spremi PDF
      </button>
      <!-- DODANO: Merge dugme -->
      <button onclick="showMergeModal()">
        <i class="fas fa-object-group"></i> Merge
      </button>
    </div>
    
    <!-- DODANO: Merge PDF sekcija -->
    <div id="mergePdfSection" class="merge-pdf-container" style="display: none;">
      <h3><i class="fas fa-object-group"></i> Spoji PDF dokumente</h3>
      <div class="form-group">
        <label>Odaberite PDF dokumente za spajanje:</label>
        <input type="file" id="mergePdfInput" accept="application/pdf" multiple>
        <button onclick="document.getElementById('mergePdfInput').click()">
          <i class="fas fa-plus"></i> Dodaj PDF-ove
        </button>
      </div>
      
      <div class="merge-file-list" id="mergeFileList"></div>
      
      <div class="form-actions">
        <button onclick="mergePdfs()" id="mergeButton" disabled>
          <i class="fas fa-object-group"></i> Spoji PDF-ove
        </button>
        <button onclick="hideMergeSection()">
          <i class="fas fa-times"></i> Odustani
        </button>
      </div>
      
      <!-- DODANO: Download PDF dugme -->
      <div id="downloadPdfContainer" style="display: none; margin-top: 15px;">
        <button id="downloadPdfButton" class="download-pdf-btn" onclick="downloadMergedPdf()">
          <i class="fas fa-download"></i> Preuzmi spojeni PDF
        </button>
      </div>
      
      <div id="mergeStatus" class="merge-status"></div>
    </div>
    
    <!-- DODANO: Dugmad za Txt i Audio funkcionalnosti -->
    <div class="import-actions">
      <button onclick="showFormatSelector()">
        <i class="fas fa-file-alt"></i> Preuzmi kao .doc
      </button>
      <button onclick="showAudioControls()">
        <i class="fas fa-volume-up"></i> Audio
      </button>
    </div>
    
    <!-- DODANO: Format selector -->
    <div id="formatSelector" class="format-selector" style="display: none;">
      <label>
        <input type="radio" name="format" value="txt" checked> Preuzmi kao .txt
      </label>
      <label>
        <input type="radio" name="format" value="doc"> Preuzmi kao .doc
      </label>
      <button onclick="convertPdfToText()">
        <i class="fas fa-download"></i> Preuzmi
      </button>
    </div>
    
    <!-- DODANO: Audio kontrole -->
    <div id="audioControls" class="audio-controls" style="display: none;">
      <button onclick="preparePdfForAudio()">
        <i class="fas fa-file-pdf"></i> Slu≈°aj PDF
      </button>
      <button onclick="loadTxtForAudio()">
        <i class="fas fa-file-alt"></i> Slu≈°aj TXT
      </button>
      <button id="playBtn" onclick="playAudio()" disabled>
        <i class="fas fa-play"></i> Play
      </button>
      <button id="pauseBtn" onclick="pauseAudio()" disabled>
        <i class="fas fa-pause"></i> Pause
      </button>
      <button id="nextBtn" onclick="nextAudioChunk()" disabled>
        <i class="fas fa-forward"></i> Sljedeƒái
      </button>
      <button onclick="downloadAudio()">
        <i class="fas fa-download"></i> Preuzmi
      </button>
    </div>
    
    <!-- DODANO: Audio progress bar -->
    <div id="audioProgress" class="audio-progress" style="display: none;">
      <div class="audio-progress-bar">
        <div id="audioProgressFill" class="audio-progress-fill"></div>
      </div>
      <div id="audioStatus" class="audio-status">Status: Spreman</div>
    </div>
    
    <div id="pdfDisplay"></div>
  </div>

  <!-- Modal za prikaz detalja za datum -->
  <div id="dateDetailsModal" class="modal">
    <h2><i class="fas fa-info-circle"></i> Detalji za datum: <span id="detailsDate"></span></h2>
    <div id="detailsContent"></div>
    <div style="margin-top: 15px; display: flex; gap: 10px;">
      <button onclick="exportDetailsCSV()" style="flex: 1;">
        <i class="fas fa-file-csv"></i> Eksport CSV
      </button>
      <button onclick="exportDetailsJSON()" style="flex: 1;">
        <i class="fas fa-file-code"></i> Eksport JSON
      </button>
    </div>
    <div class="form-actions" style="margin-top: 15px;">
      <button onclick="closeDateDetailsModal()">
        <i class="fas fa-times"></i> Zatvori
      </button>
    </div>
  </div>

  <!-- Modal za podsjetnik -->
  <div id="reminderModal" class="modal">
    <div class="container">
      <h1><i class="fas fa-bell"></i> Smart Reminder App</h1>
      <form id="taskForm">
        <div class="form-group">
          <label for="reminderTitle">Naslov zadatka:</label>
          <input type="text" id="reminderTitle" required>
        </div>

        <div class="form-group">
          <label for="reminderMessage">Poruka:</label>
          <textarea id="reminderMessage" required></textarea>
        </div>

        <div class="form-group">
          <label for="sendChannel">Kanal slanja:</label>
          <select id="sendChannel" required>
            <option value="email">E-mail</option>
            <option value="whatsapp">WhatsApp</option>
          </select>
        </div>

        <div class="form-group" id="emailGroup">
          <label for="email">E-mail adresa:</label>
          <input type="email" id="email">
        </div>

        <div class="form-group" id="whatsappGroup" style="display: none;">
          <label for="phone">WhatsApp broj (npr. +385123456789):</label>
          <input type="tel" id="phone" pattern="\+[0-9]{10,15}">
          <!-- DODANO: Polje za API kljuƒç -->
          <label for="whatsappApiKey">CallMeBot API kljuƒç (opcionalno):</label>
          <input type="text" id="whatsappApiKey" placeholder="Unesite API kljuƒç ako ga imate">
          <small style="color: #666; font-size: 12px;">Bez API kljuƒça, poruka ƒáe biti poslana na default broj</small>
        </div>

        <div class="form-group">
          <label for="scheduleTime">Vrijeme slanja:</label>
          <input type="datetime-local" id="scheduleTime" required>
        </div>

        <div class="form-actions">
          <button type="submit">
            <i class="fas fa-paper-plane"></i> Postavi podsjetnik
          </button>
          <button type="button" onclick="closeModals()">
            <i class="fas fa-times"></i> Zatvori
          </button>
        </div>
      </form>

      <div id="statusMessage"></div>
    </div>
  </div>

  <!-- Modal za Modern Habit Tracker -->
  <div id="modernHabitTrackerModal" class="modal" style="width: 95%; max-width: 1400px; height: 95%;">
    <div class="modern-habit-tracker">
      <div class="streak-counter">
        <i class="fas fa-fire"></i>
        <span id="streak-value">0</span> dana
      </div>
      
      <div class="greeting" id="greeting"></div>
      
      <div class="charts-container">
        <div class="progress-card">
          <h3><i class="fas fa-calendar-day"></i> Dnevni Progres</h3>
          <div class="circular-progress">
            <div class="progress-value">0%</div>
          </div>
        </div>
        
        <div class="progress-card">
          <h3><i class="fas fa-calendar-week"></i> Sedmiƒçni Progres</h3>
          <div class="circular-progress">
            <div class="progress-value">0%</div>
          </div>
        </div>
        
        <div class="progress-card">
          <h3><i class="fas fa-calendar-alt"></i> Mjeseƒçni Progres</h3>
          <div class="circular-progress">
            <div class="progress-value">0%</div>
          </div>
        </div>
      </div>

      <h1><i class="fas fa-chart-line"></i> Habit Tracker</h1>
      
      <div class="controls">
        <select id="monthSelect">
          <option value="0">Januar</option>
          <option value="1">Februar</option>
          <option value="2">Mart</option>
          <option value="3">April</option>
          <option value="4">Maj</option>
          <option value="5">Juni</option>
          <option value="6">Juli</option>
          <option value="7">Avgust</option>
          <option value="8">Septembar</option>
          <option value="9">Oktobar</option>
          <option value="10">Novembar</option>
          <option value="11">Decembar</option>
        </select>
        
        <select id="yearSelect">
          <option>2023</option>
          <option>2024</option>
          <option selected>2025</option>
          <option>2026</option>
        </select>

        <input type="text" id="new-task" placeholder="Unesi novi habit">
        <button class="add-btn" onclick="addTask()"><i class="fas fa-plus"></i> Dodaj habit</button>
      </div>

      <table id="main-table">
        <tr class="stats-row monthly-stats">
          <th class="task-name"><i class="fas fa-calendar-alt"></i> Mjeseƒçno ostvarenje</th>
          <td colspan="31">
            <div class="stats-container">
              <div class="progress-bar" style="width: 0%"></div>
              <div class="stats-text">
                <span class="percentage-text">0%</span> (<span class="completed-tasks">0</span>/<span class="total-tasks">0</span>)
              </div>
            </div>
          </td>
        </tr>
        
        <tr class="stats-row weekly-stats">
          <th class="task-name"><i class="fas fa-calendar-week"></i> Sedmiƒçno ostvarenje</th>
        </tr>
        
        <tr id="date-headers"></tr>
      </table>

      <div class="theme-picker">
        <button class="theme-btn" onclick="changeTheme('light')"><i class="fas fa-sun"></i></button>
        <button class="theme-btn" onclick="changeTheme('dark')"><i class="fas fa-moon"></i></button>
        <button class="theme-btn" onclick="changeTheme('nature')"><i class="fas fa-leaf"></i></button>
      </div>

      <div class="form-actions" style="margin-top: 20px;">
        <button onclick="closeModals()">
          <i class="fas fa-times"></i> Zatvori Habit Tracker
        </button>
      </div>
    </div>
  </div>

  <!-- Container za vatromet -->
  <div id="fireworkContainer" class="firework-container"></div>

  <script>
    // JavaScript kod za glavnu aplikaciju
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    let notes = JSON.parse(localStorage.getItem('notes')) || [];
    let reminders = JSON.parse(localStorage.getItem('reminders')) || [];
    let habits = JSON.parse(localStorage.getItem('habits')) || [];
    let selectedDate = null;
    let loadedPdfBytes = null;
    let loadedPdfDoc = null;
    let pdfNotes = []; // DODANO: Za pohranu napomena na PDF-u
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let scheduledReminders = JSON.parse(localStorage.getItem('scheduledReminders')) || [];
    
    // DODANO: Varijable za audio funkcionalnost
    let speechSynthesis = window.speechSynthesis;
    let currentUtterance = null;
    let isPlaying = false;
    let isPaused = false;
    let audioProgressInterval = null;
    let currentTextChunks = [];
    let currentChunkIndex = 0;
    let currentAudioText = "";

    // DODANO: Varijable za Merge funkcionalnost
    let mergeFiles = []; // Niz za pohranu odabranih PDF-ova za spajanje
    let mergedPdfBytes = null; // DODANO: Za pohranu spojenog PDF-a

    // Inicijalizacija - oslu≈°kivanje ESC tipke
    document.addEventListener('DOMContentLoaded', function() {
      initDarkMode();
      generateCalendar();
      checkScheduledReminders();
      
      // ESC tipka zatvara modale
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeModals();
        }
      });
      
      // Dugme "Zaka≈æi" je uvijek aktivno
      document.getElementById('scheduleButton').disabled = false;

      // Inicijalizacija Modern Habit Tracker-a
      initModernHabitTracker();

      // DODANO: Inicijalizacija Merge funkcionalnosti
      initMergeFunctionality();
      
      // DODANO: Inicijalizacija reminder form-a
      initReminderForm();
    });

    // DODANO: Inicijalizacija Merge funkcionalnosti
    function initMergeFunctionality() {
      const mergePdfInput = document.getElementById('mergePdfInput');
      if (mergePdfInput) {
        mergePdfInput.addEventListener('change', handleMergeFileSelection);
      }
    }

    // DODANO: Funkcija za prikaz Merge sekcije
    function showMergeModal() {
      const mergeSection = document.getElementById('mergePdfSection');
      mergeSection.style.display = 'block';
      
      // Resetiraj stanje
      mergeFiles = [];
      updateMergeFileList();
      document.getElementById('mergeButton').disabled = true;
      document.getElementById('mergeStatus').textContent = '';
      document.getElementById('mergeStatus').className = 'merge-status';
      document.getElementById('downloadPdfContainer').style.display = 'none';
    }

    // DODANO: Funkcija za sakrivanje Merge sekcije
    function hideMergeSection() {
      const mergeSection = document.getElementById('mergePdfSection');
      mergeSection.style.display = 'none';
    }

    // DODANO: Funkcija za rukovanje odabirom datoteka za spajanje
    function handleMergeFileSelection(event) {
      const files = Array.from(event.target.files);
      
      // Dodaj samo PDF datoteke
      const pdfFiles = files.filter(file => file.type === 'application/pdf');
      
      // Dodaj datoteke u niz
      pdfFiles.forEach(file => {
        mergeFiles.push({
          id: Date.now() + Math.random(),
          name: file.name,
          file: file
        });
      });
      
      // A≈æuriraj prikaz i stanje
      updateMergeFileList();
      document.getElementById('mergeButton').disabled = mergeFiles.length < 2;
      document.getElementById('mergeStatus').textContent = '';
      document.getElementById('downloadPdfContainer').style.display = 'none';
      
      // Resetiraj input
      event.target.value = '';
    }

    // DODANO: Funkcija za a≈æuriranje liste datoteka za spajanje
    function updateMergeFileList() {
      const fileList = document.getElementById('mergeFileList');
      fileList.innerHTML = '';
      
      if (mergeFiles.length === 0) {
        fileList.innerHTML = '<p>Nema odabranih PDF dokumenta</p>';
        return;
      }
      
      mergeFiles.forEach((fileObj, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'merge-file-item';
        fileItem.innerHTML = `
          <div class="file-info">
            <i class="fas fa-file-pdf"></i>
            <span>${fileObj.name}</span>
          </div>
          <div class="file-actions">
            <button class="remove-btn" onclick="removeMergeFile(${index})">
              <i class="fas fa-times"></i> Ukloni
            </button>
          </div>
        `;
        fileList.appendChild(fileItem);
      });
    }

    // DODANO: Funkcija za uklanjanje datoteke iz liste za spajanje
    function removeMergeFile(index) {
      mergeFiles.splice(index, 1);
      updateMergeFileList();
      document.getElementById('mergeButton').disabled = mergeFiles.length < 2;
      document.getElementById('downloadPdfContainer').style.display = 'none';
    }

    // DODANO: Funkcija za spajanje PDF-ova - ISPRAVLJENA VERZIJA
    async function mergePdfs() {
      if (mergeFiles.length < 2) {
        showMergeStatus('Molimo odaberite barem 2 PDF dokumenta za spajanje.', 'error');
        return;
      }
      
      const statusElement = document.getElementById('mergeStatus');
      statusElement.textContent = 'Spajam PDF dokumente...';
      statusElement.className = 'merge-status';
      
      try {
        // Kreiraj novi PDF dokument
        const mergedPdf = await PDFLib.PDFDocument.create();
        
        // Uƒçitaj i kopiraj stranice iz svakog PDF-a
        for (const fileObj of mergeFiles) {
          const pdfBytes = await readFileAsArrayBuffer(fileObj.file);
          const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
          const pages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
          pages.forEach(page => mergedPdf.addPage(page));
        }
        
        // Saƒçuvaj spojeni PDF
        mergedPdfBytes = await mergedPdf.save();
        
        showMergeStatus('PDF dokumenti su uspje≈°no spojeni! Sada ih mo≈æete preuzeti.', 'success');
        
        // Prika≈æi dugme za preuzimanje
        document.getElementById('downloadPdfContainer').style.display = 'block';
        
      } catch (error) {
        console.error('Gre≈°ka pri spajanju PDF-ova:', error);
        showMergeStatus('Do≈°lo je do gre≈°ke pri spajanju PDF-ova: ' + error.message, 'error');
      }
    }

    // DODANO: Pomoƒána funkcija za ƒçitanje datoteke kao ArrayBuffer
    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    // DODANO: Funkcija za preuzimanje spojenog PDF-a
    function downloadMergedPdf() {
      if (!mergedPdfBytes) {
        showMergeStatus('Nema spojenog PDF-a za preuzimanje.', 'error');
        return;
      }
      
      // Generiraj ime datoteke prema specifikaciji
      const fileName = generateMergedPdfName();
      
      // Kreiraj Blob i preuzmi
      const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showMergeStatus('PDF uspje≈°no preuzet!', 'success');
    }

    // DODANO: Funkcija za generiranje imena spojenog PDF-a
    function generateMergedPdfName() {
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const dateStr = `${day}.${month}`;
      
      // Uƒçitaj broj preuzimanja iz localStorage ili postavi na 1
      let downloadCount = parseInt(localStorage.getItem('pdfMergeDownloadCount')) || 0;
      downloadCount++;
      localStorage.setItem('pdfMergeDownloadCount', downloadCount.toString());
      
      return `${dateStr}_nmb_${downloadCount}.pdf`;
    }

    // DODANO: Funkcija za prikaz statusa spajanja
    function showMergeStatus(message, type) {
      const statusElement = document.getElementById('mergeStatus');
      statusElement.textContent = message;
      statusElement.className = `merge-status ${type}`;
    }

    // Dark Mode funkcije
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    function initDarkMode() {
      const darkMode = localStorage.getItem('darkMode') === 'true';
      if (darkMode) {
        document.body.classList.add('dark-mode');
      }
    }

    // MODERN HABIT TRACKER FUNKCIONALNOST
    let currentDates = [];
    let columnRanges = [];
    const days = ['Ne', 'Po', 'Ut', 'Sr', 'ƒåe', 'Pe', 'Su'];
    let currentStreak = 0;
    let lastCompletionDate = null;

    function initModernHabitTracker() {
      updateGreeting();
      setInterval(updateGreeting, 1000 * 60 * 60);
      
      const now = new Date();
      document.getElementById('monthSelect').value = now.getMonth();
      document.getElementById('yearSelect').value = now.getFullYear();
      
      document.getElementById('monthSelect').addEventListener('change', updateTable);
      document.getElementById('yearSelect').addEventListener('change', updateTable);
      document.getElementById('new-task').addEventListener('keypress', function(e) {
        if(e.key === 'Enter') addTask();
      });
      
      loadData();
      updateTable();
    }

    function updateGreeting() {
      const hour = new Date().getHours();
      const greeting = 
        hour < 12 ? 'Dobro jutro' :
        hour < 18 ? 'Dobar dan' : 'Dobra veƒçer';
      document.getElementById('greeting').textContent = `${greeting}! Pratite svoje navike danas!`;
    }

    function changeTheme(theme) {
      const modal = document.getElementById('modernHabitTrackerModal');
      modal.setAttribute('data-theme', theme);
      localStorage.setItem('habitTrackerTheme', theme);
    }

    function initHabitTrackerTheme() {
      const savedTheme = localStorage.getItem('habitTrackerTheme') || 'light';
      changeTheme(savedTheme);
    }

    function getDaysArray(year, month) {
      const date = new Date(year, month, 1);
      const result = [];
      while (date.getMonth() === month) {
        result.push({
          day: date.getDate(),
          weekDay: days[date.getDay()],
          dayOfWeek: date.getDay(),
          fullDate: new Date(date)
        });
        date.setDate(date.getDate() + 1);
      }
      return result;
    }

    function groupIntoWeeks(daysArray) {
      const weeks = [];
      let currentWeek = [];
      
      daysArray.forEach(day => {
        currentWeek.push(day);
        if (day.dayOfWeek === 6 || day.day === daysArray[daysArray.length-1].day) {
          weeks.push(currentWeek);
          currentWeek = [];
        }
      });
      
      return weeks;
    }

    function updateTable() {
      const month = parseInt(document.getElementById('monthSelect').value);
      const year = parseInt(document.getElementById('yearSelect').value);
      currentDates = getDaysArray(year, month);
      
      const headersRow = document.getElementById('date-headers');
      headersRow.innerHTML = '<th class="task-name">Habit</th>';
      currentDates.forEach(d => {
        headersRow.innerHTML += `<th class="date-header">${d.weekDay}<br>${d.day}</th>`;
      });

      document.querySelector('.monthly-stats td').colSpan = currentDates.length;

      const weeks = groupIntoWeeks(currentDates);
      const weeklyStatsRow = document.querySelector('.weekly-stats');
      weeklyStatsRow.innerHTML = '<th class="task-name"><i class="fas fa-calendar-week"></i> Sedmiƒçno ostvarenje</th>';
      
      columnRanges = [];
      let currentStart = 0;
      weeks.forEach(week => {
        const weekLength = week.length;
        columnRanges.push({ start: currentStart, end: currentStart + weekLength - 1 });
        currentStart += weekLength;
        
        const td = document.createElement('td');
        td.colSpan = weekLength;
        td.innerHTML = `
          <div class="stats-container">
            <div class="progress-bar" style="width: 0%"></div>
            <div class="stats-text">
              <span class="percentage-text">0%</span> (<span class="completed">0</span>/<span class="total">0</span>)
            </div>
          </div>
        `;
        weeklyStatsRow.appendChild(td);
      });

      loadMonthData(month, year);
      calculateStats();
    }

    function addTask() {
      const taskName = document.getElementById('new-task').value.trim();
      if (!taskName) {
        const input = document.getElementById('new-task');
        input.classList.add('error');
        setTimeout(() => input.classList.remove('error'), 500);
        return;
      }

      const table = document.getElementById('main-table');
      const newRow = document.createElement('tr');
      
      let cells = `<td class="task-name">${taskName} <button class="delete-btn" onclick="deleteTask(this)"><i class="fas fa-trash-alt"></i> Obri≈°i</button></td>`;
      currentDates.forEach(() => {
        cells += '<td><input type="checkbox" onclick="handleCheckboxChange(this)"></td>';
      });
      
      newRow.innerHTML = cells;
      const dateHeaders = document.getElementById('date-headers');
      table.insertBefore(newRow, dateHeaders.nextElementSibling);

      document.getElementById('new-task').value = '';
      calculateStats();
      saveData();
    }

    function deleteTask(button) {
      if (confirm('Da li ste sigurni da ≈æelite obrisati ovaj habit?')) {
        button.closest('tr').remove();
        calculateStats();
        saveData();
      }
    }

    function handleCheckboxChange(checkbox) {
      calculateStats();
      updateStreak();
      saveData();
    }

    function calculateStats() {
      const rows = document.querySelectorAll('#main-table tr:not(.stats-row)');
      let totalChecked = 0;
      let totalBoxes = 0;
      
      rows.forEach(row => {
        const checkboxes = row.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          totalBoxes++;
          if (checkbox.checked) totalChecked++;
        });
      });

      const monthlyPercentage = totalBoxes > 0 ? (totalChecked / totalBoxes * 100).toFixed(1) : 0;
      const monthlyBar = document.querySelector('.monthly-stats .progress-bar');
      monthlyBar.style.width = `${monthlyPercentage}%`;
      
      document.querySelector('.monthly-stats .percentage-text').textContent = `${monthlyPercentage}%`;
      document.querySelector('.monthly-stats .completed-tasks').textContent = totalChecked;
      document.querySelector('.monthly-stats .total-tasks').textContent = totalBoxes;

      const weeklyBars = document.querySelectorAll('.weekly-stats .progress-bar');
      const weeklyPercentages = [];
      weeklyBars.forEach((bar, weekIndex) => {
        const range = columnRanges[weekIndex];
        let weekChecked = 0;
        let weekTotal = 0;

        rows.forEach(row => {
          const cells = row.cells;
          for (let i = range.start + 1; i <= range.end + 1; i++) {
            if (cells[i]) {
              const checkbox = cells[i].querySelector('input[type="checkbox"]');
              if (checkbox) {
                weekTotal++;
                if (checkbox.checked) weekChecked++;
              }
            }
          }
        });

        const weekPercentage = weekTotal > 0 ? (weekChecked / weekTotal * 100).toFixed(1) : 0;
        bar.style.width = `${weekPercentage}%`;
        bar.closest('td').querySelector('.percentage-text').textContent = `${weekPercentage}%`;
        weeklyPercentages.push(parseFloat(weekPercentage));
      });

      const totalTasks = rows.length;
      const dailyCompleted = new Array(currentDates.length).fill(0);
      rows.forEach(row => {
        const checkboxes = row.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach((checkbox, dayIndex) => {
          if (checkbox.checked) {
            dailyCompleted[dayIndex]++;
          }
        });
      });

      const dailyPercentages = [];
      currentDates.forEach((day, dayIndex) => {
        const completed = dailyCompleted[dayIndex];
        const percentage = totalTasks > 0 ? (completed / totalTasks * 100) : 0;
        dailyPercentages.push(percentage);
      });

      const dailyAvg = dailyPercentages.length > 0 ? 
        dailyPercentages.reduce((a, b) => a + b, 0) / dailyPercentages.length : 0;
      
      const weeklyAvg = weeklyPercentages.length > 0 ? 
        weeklyPercentages.reduce((a, b) => a + b, 0) / weeklyPercentages.length : 0;

      const progressCircles = document.querySelectorAll('.progress-card .circular-progress');
      
      progressCircles[0].style.setProperty('--progress', `${dailyAvg}%`);
      progressCircles[0].querySelector('.progress-value').textContent = `${dailyAvg.toFixed(1)}%`;
      
      progressCircles[1].style.setProperty('--progress', `${weeklyAvg}%`);
      progressCircles[1].querySelector('.progress-value').textContent = `${weeklyAvg.toFixed(1)}%`;
      
      progressCircles[2].style.setProperty('--progress', `${monthlyPercentage}%`);
      progressCircles[2].querySelector('.progress-value').textContent = `${monthlyPercentage}%`;
    }

    function updateStreak() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      if (lastCompletionDate) {
        const lastDate = new Date(lastCompletionDate);
        lastDate.setHours(0, 0, 0, 0);
        
        const diffTime = today - lastDate;
        const diffDays = diffTime / (1000 * 60 * 60 * 24);
        
        if (diffDays === 1) {
          currentStreak++;
        } else if (diffDays > 1) {
          currentStreak = 1;
        }
      } else {
        currentStreak = 1;
      }
      
      lastCompletionDate = today;
      document.getElementById('streak-value').textContent = currentStreak;
    }

    function saveData() {
      const month = parseInt(document.getElementById('monthSelect').value);
      const year = parseInt(document.getElementById('yearSelect').value);
      const key = `habits_${year}_${month}`;
      
      const habits = [];
      document.querySelectorAll('#main-table tr:not(.stats-row)').forEach(row => {
        const habit = {
          name: row.cells[0].textContent.replace(' Obri≈°i', ''),
          days: []
        };
        
        const checkboxes = row.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          habit.days.push(checkbox.checked);
        });
        
        habits.push(habit);
      });
      
      localStorage.setItem(key, JSON.stringify(habits));
      localStorage.setItem('streak', currentStreak);
      localStorage.setItem('lastCompletion', lastCompletionDate);
    }

    function loadData() {
      const savedStreak = localStorage.getItem('streak');
      if (savedStreak) {
        currentStreak = parseInt(savedStreak);
        document.getElementById('streak-value').textContent = currentStreak;
      }
      
      const lastDate = localStorage.getItem('lastCompletion');
      if (lastDate) {
        lastCompletionDate = new Date(lastDate);
      }
    }

    function loadMonthData(month, year) {
      const key = `habits_${year}_${month}`;
      const savedData = localStorage.getItem(key);
      
      if (savedData) {
        const habits = JSON.parse(savedData);
        habits.forEach(habit => {
          if (!document.querySelector(`td.task-name:contains("${habit.name}")`)) {
            document.getElementById('new-task').value = habit.name;
            addTask();
          }
          
          const rows = document.querySelectorAll('#main-table tr:not(.stats-row)');
          rows.forEach(row => {
            if (row.cells[0].textContent.replace(' Obri≈°i', '') === habit.name) {
              const checkboxes = row.querySelectorAll('input[type="checkbox"]');
              checkboxes.forEach((checkbox, index) => {
                if (habit.days[index]) {
                  checkbox.checked = true;
                }
              });
            }
          });
        });
      }
    }

    // Swipe za mobilne ureƒëaje
    let touchStartX = 0;
    document.addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    });

    document.addEventListener('touchend', e => {
      const touchEndX = e.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;
      
      if (Math.abs(diff) > 50) {
        const monthSelect = document.getElementById('monthSelect');
        if (diff > 0) {
          monthSelect.value = Math.min(11, parseInt(monthSelect.value) + 1);
        } else {
          monthSelect.value = Math.max(0, parseInt(monthSelect.value) - 1);
        }
        monthSelect.dispatchEvent(new Event('change'));
      }
    });

    // KRAJ MODERN HABIT TRACKER FUNKCIONALNOSTI

    // Funkcija za prikaz Modern Habit Tracker modala
    function showModernHabitTracker() {
      document.getElementById('modernHabitTrackerModal').classList.add('show');
      document.getElementById('overlay').classList.add('show');
      initHabitTrackerTheme();
    }

    // Generisanje kalendara
    function generateCalendar() {
      const calendarBody = document.getElementById('calendarBody');
      const monthYear = document.getElementById('monthYear');
      calendarBody.innerHTML = '';

      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const adjustedFirstDay = (firstDay + 6) % 7; // Prilagodba za hrvatski kalendar (ponedjeljak kao prvi dan)
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      monthYear.textContent = `${new Date(currentYear, currentMonth).toLocaleString('hr-HR', { month: 'long' })} ${currentYear}`;
      let day = 1;

      for (let i = 0; i < 6; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement('td');
          if ((i === 0 && j < adjustedFirstDay) || day > daysInMonth) {
            cell.textContent = '';
          } else {
            cell.textContent = day;
            const cellDay = day;
            const cellDate = new Date(currentYear, currentMonth, cellDay);

            // DODANO: Ukljuƒçivanje podsjetnika u provjeru
            if (
              tasks.some(t => new Date(t.date).toDateString() === cellDate.toDateString()) ||
              notes.some(n => new Date(n.date).toDateString() === cellDate.toDateString()) ||
              reminders.some(r => new Date(r.date).toDateString() === cellDate.toDateString())
            ) {
              cell.classList.add('has-entry');
            }

            cell.onclick = function() {
              showDateDetails(new Date(currentYear, currentMonth, cellDay));
            };
            day++;
          }
          row.appendChild(cell);
        }
        calendarBody.appendChild(row);
      }
    }

    // Navigacija kalendarom
    function nextMonth() {
      if (currentMonth === 11) {
        currentMonth = 0;
        currentYear++;
      } else {
        currentMonth++;
      }
      generateCalendar();
    }

    function prevMonth() {
      if (currentMonth === 0) {
        currentMonth = 11;
        currentYear--;
      } else {
        currentMonth--;
      }
      generateCalendar();
    }

    // Clear All i PDF funkcionalnost
    function clearAllMonth() {
      if (confirm("Ova radnja ƒáe preuzeti sve bilje≈°ke, zadatke i podsjetnike ovog mjeseca u PDF formatu te izbrisati ih. Nastaviti?")) {
        exportMonthPDF(true);
      }
    }

    function exportMonthPDF(clearAfterExport = false) {
      const monthTasks = tasks.filter(t => {
        const d = new Date(t.date);
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
      });
      const monthNotes = notes.filter(n => {
        const d = new Date(n.date);
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
      });
      // DODANO: Ukljuƒçivanje podsjetnika
      const monthReminders = reminders.filter(r => {
        const d = new Date(r.date);
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
      });

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let yOffset = 10;

      doc.text("Zadatci:", 10, yOffset);
      yOffset += 10;
      monthTasks.forEach(t => {
        doc.text(`- ${t.title} (${new Date(t.date).toLocaleString('hr-HR')})`, 10, yOffset);
        yOffset += 10;
      });

      yOffset += 10;
      doc.text("Bilje≈°ke:", 10, yOffset);
      yOffset += 10;
      monthNotes.forEach(n => {
        doc.text(`- ${n.text} (${new Date(n.date).toLocaleString('hr-HR')})`, 10, yOffset);
        yOffset += 10;
      });

      // DODANO: Prikaz podsjetnika
      yOffset += 10;
      doc.text("Podsjetnici:", 10, yOffset);
      yOffset += 10;
      monthReminders.forEach(r => {
        doc.text(`- ${r.title} (${r.channel}) - ${new Date(r.date).toLocaleString('hr-HR')}`, 10, yOffset);
        yOffset += 10;
      });

      doc.save(`moj_mjesec_${currentMonth+1}_${currentYear}.pdf`);

      if (clearAfterExport) {
        tasks = tasks.filter(t => {
          const d = new Date(t.date);
          return d.getMonth() !== currentMonth || d.getFullYear() !== currentYear;
        });
        notes = notes.filter(n => {
          const d = new Date(n.date);
          return d.getMonth() !== currentMonth || d.getFullYear() !== currentYear;
        });
        // DODANO: Brisanje podsjetnika
        reminders = reminders.filter(r => {
          const d = new Date(r.date);
          return d.getMonth() !== currentMonth || d.getFullYear() !== currentYear;
        });
        localStorage.setItem('tasks', JSON.stringify(tasks));
        localStorage.setItem('notes', JSON.stringify(notes));
        localStorage.setItem('reminders', JSON.stringify(reminders));
      }
      generateCalendar();
    }

    // Funkcije za zadatke
    function showTaskModal() {
      document.getElementById('taskModal').classList.add('show');
      document.getElementById('overlay').classList.add('show');
    }

    function saveTask() {
      const title = document.getElementById('taskTitle').value;
      const date = document.getElementById('taskDate').value;
      if (title && date) {
        tasks.push({ title, date });
        localStorage.setItem('tasks', JSON.stringify(tasks));
        closeModals();
        setTimeout(showFireworks, 100);
        generateCalendar();
      }
    }

    // Funkcije za bilje≈°ke
    function showNotesModal() {
      document.getElementById('notesModal').classList.add('show');
      document.getElementById('overlay').classList.add('show');
    }

    function addNote() {
      const text = document.getElementById('noteText').value;
      const date = document.getElementById('noteDate').value;
      if (text && date) {
        notes.push({ text, date });
        localStorage.setItem('notes', JSON.stringify(notes));
        closeModals();
        setTimeout(showFireworks, 100);
        generateCalendar();
      }
    }

    // Funkcije za PDF
    function showPdfImportModal() {
      document.getElementById('pdfImportModal').classList.add('show');
      document.getElementById('overlay').classList.add('show');
    }

    // DODANO: Funkcije za upravljanje veliƒçinom modala
    function maximizeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.add('maximized');
    }

    function minimizeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('maximized');
    }

    document.getElementById('pdfFileInput').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file && file.type === "application/pdf") {
        const reader = new FileReader();
        reader.onload = async (e) => {
          loadedPdfBytes = e.target.result;
          await renderPdf(loadedPdfBytes);
        };
        reader.readAsArrayBuffer(file);
      }
    });

    // DODANO: Renderiranje svih stranica PDF-a
    async function renderPdf(pdfBytes) {
      const pdfDisplay = document.getElementById('pdfDisplay');
      pdfDisplay.innerHTML = "";
      const typedArray = new Uint8Array(pdfBytes);
      const loadingTask = pdfjsLib.getDocument(typedArray);
      const pdf = await loadingTask.promise;
      loadedPdfDoc = pdf; // Pohrani PDF dokument za kasniju ekstrakciju teksta

      // Renderiraj sve stranice
      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 1.2 });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        canvas.className = 'pdf-page';
        
        await page.render({ canvasContext: context, viewport: viewport }).promise;
        pdfDisplay.appendChild(canvas);
      }
    }

    function addNoteToPdf() {
      const color = document.getElementById('noteColor').value;
      const note = document.createElement('textarea');
      note.className = 'note';
      note.style.backgroundColor = color;
      note.style.left = '10px';
      note.style.top = '10px';
      note.placeholder = 'Unesite napomenu...';
      note.addEventListener('mousedown', startDragging);
      
      // DODANO: Pohrani napomenu
      const noteId = Date.now().toString();
      note.setAttribute('data-note-id', noteId);
      pdfNotes.push({
        id: noteId,
        text: '',
        color: color,
        x: 10,
        y: 10
      });
      
      note.addEventListener('input', function() {
        const noteIndex = pdfNotes.findIndex(n => n.id === noteId);
        if (noteIndex !== -1) {
          pdfNotes[noteIndex].text = this.value;
        }
      });
      
      document.getElementById('pdfDisplay').appendChild(note);
    }

    function startDragging(e) {
      const note = e.target;
      const offsetX = e.clientX - note.getBoundingClientRect().left;
      const offsetY = e.clientY - note.getBoundingClientRect().top;

      function moveHandler(moveEvent) {
        const newX = moveEvent.clientX - offsetX - document.getElementById('pdfDisplay').getBoundingClientRect().left;
        const newY = moveEvent.clientY - offsetY - document.getElementById('pdfDisplay').getBoundingClientRect().top;
        
        note.style.left = `${newX}px`;
        note.style.top = `${newY}px`;
        
        // A≈æuriraj poziciju u pohranjenim napomenama
        const noteId = note.getAttribute('data-note-id');
        const noteIndex = pdfNotes.findIndex(n => n.id === noteId);
        if (noteIndex !== -1) {
          pdfNotes[noteIndex].x = newX;
          pdfNotes[noteIndex].y = newY;
        }
      }

      function stopHandler() {
        document.removeEventListener('mousemove', moveHandler);
        document.removeEventListener('mouseup', stopHandler);
      }

      document.addEventListener('mousemove', moveHandler);
      document.addEventListener('mouseup', stopHandler);
    }

    async function saveEditedPdf() {
      if (!loadedPdfBytes) {
        alert("Prvo uƒçitajte PDF dokument!");
        return;
      }

      const pdfDoc = await PDFLib.PDFDocument.load(loadedPdfBytes);
      const page = pdfDoc.getPage(0);
      const notesList = document.querySelectorAll('.note');

      const { width, height } = page.getSize();
      const displayDiv = document.getElementById('pdfDisplay');
      const displayRect = displayDiv.getBoundingClientRect();
      const scaleFactor = displayDiv.firstChild.width / width;

      notesList.forEach(note => {
        const text = note.value;
        const color = note.style.backgroundColor;
        
        const x = parseFloat(note.style.left) / scaleFactor;
        const y = (parseFloat(note.style.top) / scaleFactor) * -1 + height;

        page.drawText(text, {
          x: x,
          y: y - 20,
          size: 12,
          color: getColorValue(color)
        });
      });

      const modifiedPdfBytes = await pdfDoc.save();
      const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'uredjeni-dokument.pdf';
      link.click();
    }

    function getColorValue(color) {
      switch (color) {
        case 'red': return PDFLib.rgb(1, 0, 0);
        case 'green': return PDFLib.rgb(0, 1, 0);
        default: return PDFLib.rgb(1, 1, 0);
      }
    }

    // DODANO: Funkcije za Txt dugme
    function showFormatSelector() {
      const formatSelector = document.getElementById('formatSelector');
      formatSelector.style.display = formatSelector.style.display === 'flex' ? 'none' : 'flex';
    }

    // DODANO: Pobolj≈°ana funkcija za konverziju PDF-a u tekst
    async function convertPdfToText() {
      if (!loadedPdfDoc) {
        alert("Prvo uƒçitajte PDF dokument!");
        return;
      }

      let fullText = '';

      // Ekstraktiraj tekst sa svih stranica
      for (let pageNum = 1; pageNum <= loadedPdfDoc.numPages; pageNum++) {
        const page = await loadedPdfDoc.getPage(pageNum);
        const textContent = await page.getTextContent();
        
        // Pobolj≈°ana ekstrakcija teksta - sortiraj elemente po Y poziciji
        const textItems = textContent.items;
        textItems.sort((a, b) => {
          // Sortiraj od vrha prema dnu (veƒái Y je vi≈°e)
          return b.transform[5] - a.transform[5];
        });

        let pageText = '';
        let lastY = null;
        
        for (const item of textItems) {
          const currentY = Math.round(item.transform[5]);
          
          // Dodaj novi red ako je Y pozicija znaƒçajno drugaƒçija
          if (lastY !== null && Math.abs(lastY - currentY) > 5) {
            pageText += '\n';
          }
          
          pageText += item.str + ' ';
          lastY = currentY;
        }
        
        fullText += `--- Stranica ${pageNum} ---\n${pageText.trim()}\n\n`;
      }

      // DODANO: Dodaj napomene u tekst
      if (pdfNotes.length > 0) {
        fullText += "\n\n--- NAPOMENE ---\n";
        pdfNotes.forEach((note, index) => {
          if (note.text.trim() !== '') {
            fullText += `Napomena ${index + 1} (${note.color}): ${note.text}\n`;
          }
        });
      }

      // Odredi format preuzimanja
      const format = document.querySelector('input[name="format"]:checked').value;
      
      if (format === 'txt') {
        downloadAsTxt(fullText);
      } else {
        convertToWordDocument(fullText);
      }
    }

    function downloadAsTxt(text) {
      const blob = new Blob([text], { type: 'text/plain; charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ekstrahovani-tekst.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    // DODANO: Pobolj≈°ana funkcija za konverziju u Word dokument
    function convertToWordDocument(text) {
      // Kreiraj Word-kompatibilan HTML dokument
      const htmlContent = `
        <!DOCTYPE html>
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <meta charset="UTF-8">
          <title>Ekstrahovani tekst iz PDF-a</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              line-height: 1.6;
              margin: 40px;
              color: #000000;
            }
            .page-break {
              page-break-after: always;
            }
            .note {
              background-color: #ffffcc;
              border-left: 4px solid #ffeb3b;
              padding: 10px;
              margin: 10px 0;
            }
            .header {
              font-size: 16px;
              font-weight: bold;
              margin-bottom: 10px;
              color: #2c3e50;
              border-bottom: 2px solid #3498db;
              padding-bottom: 5px;
            }
          </style>
        </head>
        <body>
          <div class="header">Ekstrahovani tekst iz PDF dokumenta</div>
          <div>Datum konverzije: ${new Date().toLocaleString('hr-HR')}</div>
          <br>
          <div>${formatTextForWord(text)}</div>
        </body>
        </html>
      `;
      
      // Kreiraj Blob sa Word MIME tipom
      const blob = new Blob([htmlContent], { 
        type: 'application/msword' 
      });
      
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ekstrahovani-tekst.doc';
      a.click();
      URL.revokeObjectURL(url);
    }

    // DODANO: Pomoƒána funkcija za formatiranje teksta za Word
    function formatTextForWord(text) {
      // Zamijeni vi≈°estruke prazne linije sa jednom
      let formattedText = text.replace(/\n\s*\n\s*\n/g, '\n\n');
      
      // Formatiraj naslove stranica
      formattedText = formattedText.replace(/--- Stranica (\d+) ---/g, '<div class="page-break"><div class="header">Stranica $1</div></div>');
      
      // Formatiraj napomene
      formattedText = formattedText.replace(/Napomena (\d+) \((.*?)\): (.*?)(?=\n|$)/g, '<div class="note"><strong>Napomena $1 ($2):</strong> $3</div>');
      
      // Zamijeni obiƒçne nov–µ redove sa HTML break tagovima
      formattedText = formattedText.replace(/\n/g, '<br>');
      
      return formattedText;
    }

    // DODANO: Funkcije za Audio dugme
    function showAudioControls() {
      const audioControls = document.getElementById('audioControls');
      const audioProgress = document.getElementById('audioProgress');
      audioControls.style.display = audioControls.style.display === 'flex' ? 'none' : 'flex';
      audioProgress.style.display = audioProgress.style.display === 'block' ? 'none' : 'block';
    }

    // DODANO: Nova funkcija za pripremu PDF-a za audio
    async function preparePdfForAudio() {
      if (!loadedPdfDoc) {
        alert("Prvo uƒçitajte PDF dokument!");
        return;
      }

      let fullText = '';

      // Ekstraktiraj tekst sa svih stranica
      for (let pageNum = 1; pageNum <= loadedPdfDoc.numPages; pageNum++) {
        const page = await loadedPdfDoc.getPage(pageNum);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + ' ';
      }

      // DODANO: Dodaj napomene u tekst
      if (pdfNotes.length > 0) {
        fullText += "\n\nNapomene: ";
        pdfNotes.forEach((note, index) => {
          if (note.text.trim() !== '') {
            fullText += `Napomena ${index + 1}: ${note.text}. `;
          }
        });
      }

      currentAudioText = fullText;
      prepareTextForAudio();
      updateAudioStatus("PDF je uƒçitan. Kliknite Play za slu≈°anje.");
      document.getElementById('playBtn').disabled = false;
    }

    // DODANO: Funkcija za pripremu teksta za audio
    function prepareTextForAudio() {
      if (!currentAudioText) return;
      
      // Podijeli tekst u manje dijelove zbog ograniƒçenja TTS-a
      const maxChunkLength = 200; // Broj znakova po dijelu
      currentTextChunks = [];
      
      // Podijeli tekst u dijelove
      for (let i = 0; i < currentAudioText.length; i += maxChunkLength) {
        currentTextChunks.push(currentAudioText.substring(i, i + maxChunkLength));
      }
      
      currentChunkIndex = 0;
      document.getElementById('nextBtn').disabled = currentTextChunks.length <= 1;
    }

    // DODANO: Funkcija za uƒçitavanje TXT datoteke
    function loadTxtForAudio() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.txt';
      
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            currentAudioText = e.target.result;
            prepareTextForAudio();
            updateAudioStatus("TXT dokument je uƒçitan. Kliknite Play za slu≈°anje.");
            document.getElementById('playBtn').disabled = false;
          };
          reader.readAsText(file);
        }
      };
      
      input.click();
    }

    // DODANO: Funkcija za reprodukciju audio zapisa
    function playAudio() {
      if (!currentAudioText || currentTextChunks.length === 0) {
        alert("Nema dostupnog teksta za reprodukciju.");
        return;
      }

      // Zaustavi prethodni audio ako postoji
      if (isPlaying) {
        speechSynthesis.cancel();
      }

      isPlaying = true;
      isPaused = false;
      document.getElementById('playBtn').disabled = true;
      document.getElementById('pauseBtn').disabled = false;
      document.getElementById('nextBtn').disabled = currentTextChunks.length <= 1;
      
      playCurrentChunk();
    }

    function playCurrentChunk() {
      if (currentChunkIndex >= currentTextChunks.length || !isPlaying) {
        // Zavr≈°ili smo s ƒçitanjem cijelog teksta ili je reprodukcija zaustavljena
        updateAudioStatus("ƒåitanje zavr≈°eno");
        document.getElementById('audioProgressFill').style.width = '100%';
        isPlaying = false;
        document.getElementById('playBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = true;
        document.getElementById('nextBtn').disabled = true;
        return;
      }

      const chunk = currentTextChunks[currentChunkIndex];
      
      // Kreiraj novi utterance
      currentUtterance = new SpeechSynthesisUtterance(chunk);
      currentUtterance.lang = 'hr-HR'; // Postavi jezik na hrvatski
      currentUtterance.rate = 0.8; // Brzina govora
      currentUtterance.pitch = 1; // Visina tona

      currentUtterance.onstart = function() {
        updateAudioStatus(`ƒåita se dio ${currentChunkIndex + 1}/${currentTextChunks.length}`);
        
        // A≈æuriraj progress bar
        const progress = ((currentChunkIndex + 1) / currentTextChunks.length) * 100;
        document.getElementById('audioProgressFill').style.width = `${progress}%`;
        
        // Pokreni interval za a≈æuriranje progress bara
        if (audioProgressInterval) clearInterval(audioProgressInterval);
        let startTime = Date.now();
        const estimatedDuration = chunk.length / (currentUtterance.rate * 10); // Procjena trajanja u ms
        
        audioProgressInterval = setInterval(() => {
          if (!isPlaying) {
            clearInterval(audioProgressInterval);
            return;
          }
          
          const elapsed = Date.now() - startTime;
          const chunkProgress = Math.min(elapsed / estimatedDuration, 1);
          const totalProgress = ((currentChunkIndex + chunkProgress) / currentTextChunks.length) * 100;
          document.getElementById('audioProgressFill').style.width = `${totalProgress}%`;
        }, 100);
      };

      currentUtterance.onend = function() {
        clearInterval(audioProgressInterval);
        currentChunkIndex++;
        if (isPlaying && !isPaused && currentChunkIndex < currentTextChunks.length) {
          playCurrentChunk();
        } else if (currentChunkIndex >= currentTextChunks.length) {
          // Zavr≈°ili smo s ƒçitanjem cijelog teksta
          updateAudioStatus("ƒåitanje zavr≈°eno");
          document.getElementById('audioProgressFill').style.width = '100%';
          isPlaying = false;
          document.getElementById('playBtn').disabled = false;
          document.getElementById('pauseBtn').disabled = true;
          document.getElementById('nextBtn').disabled = true;
        }
      };

      currentUtterance.onerror = function(event) {
        clearInterval(audioProgressInterval);
        isPlaying = false;
        updateAudioStatus("Do≈°lo je do gre≈°ke pri ƒçitanju");
        console.error("Gre≈°ka pri ƒçitanju:", event);
        document.getElementById('playBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = true;
        document.getElementById('nextBtn').disabled = true;
      };

      // Pokreni govor
      speechSynthesis.speak(currentUtterance);
    }

    // DODANO: Funkcija za prelazak na sljedeƒái dio
    function nextAudioChunk() {
      if (!isPlaying || currentChunkIndex >= currentTextChunks.length - 1) {
        return;
      }
      
      // Zaustavi trenutni govor
      speechSynthesis.cancel();
      
      // Prijeƒëi na sljedeƒái chunk
      currentChunkIndex++;
      
      // A≈æuriraj progress bar
      const progress = ((currentChunkIndex + 1) / currentTextChunks.length) * 100;
      document.getElementById('audioProgressFill').style.width = `${progress}%`;
      
      // Nastavi reprodukciju sa sljedeƒáeg chunk-a
      playCurrentChunk();
    }

    function pauseAudio() {
      if (isPlaying) {
        if (isPaused) {
          // Nastavi reprodukciju
          speechSynthesis.resume();
          isPaused = false;
          updateAudioStatus("Nastavlja se ƒçitanje...");
          document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-pause"></i> Pause';
        } else {
          // Pauziraj reprodukciju
          speechSynthesis.pause();
          isPaused = true;
          updateAudioStatus("Pauzirano");
          document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-play"></i> Resume';
        }
      }
    }

    function downloadAudio() {
      if (!currentAudioText) {
        alert("Nema dostupnog teksta za preuzimanje.");
        return;
      }

      // Kreiraj audio datoteku od teksta (simulacija)
      const audioBlob = new Blob([currentAudioText], { type: 'text/plain' });
      const url = URL.createObjectURL(audioBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'audio-tekst.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    function updateAudioStatus(message) {
      document.getElementById('audioStatus').textContent = `Status: ${message}`;
    }

    // Prikaz detalja za datum
    function showDateDetails(date) {
      selectedDate = date;
      document.getElementById('detailsDate').textContent = date.toLocaleDateString('hr-HR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      const container = document.getElementById('detailsContent');
      container.innerHTML = '';

      const dateStr = date.toDateString();
      const dayTasks = tasks.filter(t => new Date(t.date).toDateString() === dateStr);
      const dayNotes = notes.filter(n => new Date(n.date).toDateString() === dateStr);
      // DODANO: Ukljuƒçivanje podsjetnika
      const dayReminders = reminders.filter(r => new Date(r.date).toDateString() === dateStr);

      if (dayTasks.length === 0 && dayNotes.length === 0 && dayReminders.length === 0) {
        container.innerHTML = '<p>Nema unesenih zadataka, bilje≈°ki ili podsjetnika za ovaj datum.</p>';
      } else {
        // Prikaz zadataka
        dayTasks.forEach((t, idx) => {
          const entryDiv = document.createElement('div');
          entryDiv.className = 'entry-item';
          
          const entryInfo = document.createElement('div');
          entryInfo.className = 'entry-info';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `task-${idx}`;
          checkbox.onchange = function() {
            const buttons = entryDiv.querySelectorAll('.entry-actions button');
            buttons.forEach(btn => {
              btn.disabled = !this.checked;
            });
          };
          
          const icon = document.createElement('i');
          icon.className = 'fas fa-tasks';
          
          const span = document.createElement('span');
          span.textContent = t.title;
          
          const time = document.createElement('span');
          time.className = 'entry-time';
          time.textContent = new Date(t.date).toLocaleTimeString('hr-HR');
          time.style.fontSize = '0.8em';
          time.style.color = '#6c757d';
          time.style.marginLeft = 'auto';
          time.style.paddingRight = '10px';
          
          entryInfo.appendChild(checkbox);
          entryInfo.appendChild(icon);
          entryInfo.appendChild(span);
          entryInfo.appendChild(time);
          
          const entryActions = document.createElement('div');
          entryActions.className = 'entry-actions';
          
          const btnEdit = document.createElement('button');
          btnEdit.className = 'edit-btn';
          btnEdit.innerHTML = '<i class="fas fa-edit"></i>';
          btnEdit.disabled = true;
          btnEdit.onclick = function() { editEntry(idx, 'task'); };
          
          const btnDelete = document.createElement('button');
          btnDelete.className = 'delete-btn';
          btnDelete.innerHTML = '<i class="fas fa-trash-alt"></i>';
          btnDelete.disabled = true;
          btnDelete.onclick = function() { deleteEntry(idx, 'task'); };
          
          const btnConnect = document.createElement('button');
          btnConnect.className = 'connect-btn';
          btnConnect.innerHTML = '<i class="fas fa-link"></i>';
          btnConnect.disabled = true;
          btnConnect.onclick = function() { connectEntry(idx, 'task'); };
          
          entryActions.appendChild(btnEdit);
          entryActions.appendChild(btnDelete);
          entryActions.appendChild(btnConnect);
          
          entryDiv.appendChild(entryInfo);
          entryDiv.appendChild(entryActions);
          container.appendChild(entryDiv);
        });

        // Prikaz bilje≈°ki
        dayNotes.forEach((n, idx) => {
          const entryDiv = document.createElement('div');
          entryDiv.className = 'entry-item';
          
          const entryInfo = document.createElement('div');
          entryInfo.className = 'entry-info';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `note-${idx}`;
          checkbox.onchange = function() {
            const buttons = entryDiv.querySelectorAll('.entry-actions button');
            buttons.forEach(btn => {
              btn.disabled = !this.checked;
            });
          };
          
          const icon = document.createElement('i');
          icon.className = 'fas fa-sticky-note';
          
          const span = document.createElement('span');
          span.textContent = n.text.length > 50 ? n.text.substring(0, 50) + '...' : n.text;
          
          const time = document.createElement('span');
          time.className = 'entry-time';
          time.textContent = new Date(n.date).toLocaleTimeString('hr-HR');
          time.style.fontSize = '0.8em';
          time.style.color = '#6c757d';
          time.style.marginLeft = 'auto';
          time.style.paddingRight = '10px';
          
          entryInfo.appendChild(checkbox);
          entryInfo.appendChild(icon);
          entryInfo.appendChild(span);
          entryInfo.appendChild(time);
          
          const entryActions = document.createElement('div');
          entryActions.className = 'entry-actions';
          
          const btnEdit = document.createElement('button');
          btnEdit.className = 'edit-btn';
          btnEdit.innerHTML = '<i class="fas fa-edit"></i>';
          btnEdit.disabled = true;
          btnEdit.onclick = function() { editEntry(idx, 'note'); };
          
          const btnDelete = document.createElement('button');
          btnDelete.className = 'delete-btn';
          btnDelete.innerHTML = '<i class="fas fa-trash-alt"></i>';
          btnDelete.disabled = true;
          btnDelete.onclick = function() { deleteEntry(idx, 'note'); };
          
          const btnConnect = document.createElement('button');
          btnConnect.className = 'connect-btn';
          btnConnect.innerHTML = '<i class="fas fa-link"></i>';
          btnConnect.disabled = true;
          btnConnect.onclick = function() { connectEntry(idx, 'note'); };
          
          entryActions.appendChild(btnEdit);
          entryActions.appendChild(btnDelete);
          entryActions.appendChild(btnConnect);
          
          entryDiv.appendChild(entryInfo);
          entryDiv.appendChild(entryActions);
          container.appendChild(entryDiv);
        });

        // DODANO: Prikaz podsjetnika
        dayReminders.forEach((r, idx) => {
          const entryDiv = document.createElement('div');
          entryDiv.className = 'entry-item';
          
          const entryInfo = document.createElement('div');
          entryInfo.className = 'entry-info';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `reminder-${idx}`;
          checkbox.onchange = function() {
            const buttons = entryDiv.querySelectorAll('.entry-actions button');
            buttons.forEach(btn => {
              btn.disabled = !this.checked;
            });
          };
          
          const icon = document.createElement('i');
          icon.className = 'fas fa-bell';
          
          const span = document.createElement('span');
          span.textContent = `${r.title} (${r.channel})`;
          
          const time = document.createElement('span');
          time.className = 'entry-time';
          time.textContent = new Date(r.date).toLocaleTimeString('hr-HR');
          time.style.fontSize = '0.8em';
          time.style.color = '#6c757d';
          time.style.marginLeft = 'auto';
          time.style.paddingRight = '10px';
          
          entryInfo.appendChild(checkbox);
          entryInfo.appendChild(icon);
          entryInfo.appendChild(span);
          entryInfo.appendChild(time);
          
          const entryActions = document.createElement('div');
          entryActions.className = 'entry-actions';
          
          const btnEdit = document.createElement('button');
          btnEdit.className = 'edit-btn';
          btnEdit.innerHTML = '<i class="fas fa-edit"></i>';
          btnEdit.disabled = true;
          btnEdit.onclick = function() { editEntry(idx, 'reminder'); };
          
          const btnDelete = document.createElement('button');
          btnDelete.className = 'delete-btn';
          btnDelete.innerHTML = '<i class="fas fa-trash-alt"></i>';
          btnDelete.disabled = true;
          btnDelete.onclick = function() { deleteEntry(idx, 'reminder'); };
          
          const btnConnect = document.createElement('button');
          btnConnect.className = 'connect-btn';
          btnConnect.innerHTML = '<i class="fas fa-link"></i>';
          btnConnect.disabled = true;
          btnConnect.onclick = function() { connectEntry(idx, 'reminder'); };
          
          entryActions.appendChild(btnEdit);
          entryActions.appendChild(btnDelete);
          entryActions.appendChild(btnConnect);
          
          entryDiv.appendChild(entryInfo);
          entryDiv.appendChild(entryActions);
          container.appendChild(entryDiv);
        });
      }

      document.getElementById('dateDetailsModal').classList.add('show');
      document.getElementById('overlay').classList.add('show');
    }

    function closeDateDetailsModal() {
      document.getElementById('dateDetailsModal').classList.remove('show');
      document.getElementById('overlay').classList.remove('show');
    }

    // Funkcije za manipulaciju unosima
    function deleteEntry(idx, type) {
      if (confirm("Jeste li sigurni da ≈æelite obrisati ovaj unos?")) {
        if (type === 'task') {
          tasks.splice(idx, 1);
          localStorage.setItem('tasks', JSON.stringify(tasks));
        } else if (type === 'note') {
          notes.splice(idx, 1);
          localStorage.setItem('notes', JSON.stringify(notes));
        } else if (type === 'reminder') {
          // Takoƒëer uklonimo iz scheduledReminders ako postoji
          const reminderToDelete = reminders[idx];
          scheduledReminders = scheduledReminders.filter(r => r.id !== reminderToDelete.id);
          localStorage.setItem('scheduledReminders', JSON.stringify(scheduledReminders));
          
          reminders.splice(idx, 1);
          localStorage.setItem('reminders', JSON.stringify(reminders));
        }
        alert('Unos obrisan.');
        closeDateDetailsModal();
        generateCalendar();
      }
    }

    function editEntry(idx, type) {
      let currentValue, newValue;
      
      if (type === 'task') {
        currentValue = tasks[idx].title;
        newValue = prompt("Uredite unos:", currentValue);
        if (newValue !== null && newValue !== currentValue) {
          tasks[idx].title = newValue;
          localStorage.setItem('tasks', JSON.stringify(tasks));
        }
      } else if (type === 'note') {
        currentValue = notes[idx].text;
        newValue = prompt("Uredite unos:", currentValue);
        if (newValue !== null && newValue !== currentValue) {
          notes[idx].text = newValue;
          localStorage.setItem('notes', JSON.stringify(notes));
        }
      } else if (type === 'reminder') {
        currentValue = reminders[idx].title;
        newValue = prompt("Uredite naslov podsjetnika:", currentValue);
        if (newValue !== null && newValue !== currentValue) {
          reminders[idx].title = newValue;
          localStorage.setItem('reminders', JSON.stringify(reminders));
        }
      }
      
      if (newValue !== null && newValue !== currentValue) {
        alert('Unos a≈æuriran.');
        closeDateDetailsModal();
        generateCalendar();
      }
    }

    function connectEntry(idx, type) {
      alert('Unos povezan. Sada mo≈æete koristiti dugme "Zaka≈æi" za postavljanje podsjetnika.');
      closeDateDetailsModal();
    }

    // Funkcije za reminder modal
    function showReminderModal() {
      document.getElementById('reminderModal').classList.add('show');
      document.getElementById('overlay').classList.add('show');
    }

    // DODANO: Inicijalizacija reminder form-a
    function initReminderForm() {
      const channelSelector = document.getElementById('sendChannel');
      const emailGroup = document.getElementById('emailGroup');
      const whatsappGroup = document.getElementById('whatsappGroup');
      
      channelSelector.addEventListener('change', () => {
        if (channelSelector.value === 'email') {
          emailGroup.style.display = 'block';
          whatsappGroup.style.display = 'none';
        } else {
          emailGroup.style.display = 'none';
          whatsappGroup.style.display = 'block';
        }
      });

      document.getElementById('taskForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
          title: document.getElementById('reminderTitle').value,
          message: document.getElementById('reminderMessage').value,
          channel: channelSelector.value,
          recipient: channelSelector.value === 'email' 
              ? document.getElementById('email').value 
              : document.getElementById('phone').value,
          scheduleTime: document.getElementById('scheduleTime').value,
          // DODANO: WhatsApp API kljuƒç
          whatsappApiKey: channelSelector.value === 'whatsapp' 
              ? document.getElementById('whatsappApiKey').value 
              : null
        };

        if (!validateReminderInputs(formData)) return;

        try {
          // Schedule the reminder instead of sending immediately
          scheduleReminder(formData);
          showReminderMessage('Podsjetnik uspje≈°no zaka≈æan! Poruka ƒáe biti poslana u zaka≈æano vrijeme.', true);
          document.getElementById('taskForm').reset();
        } catch (error) {
          showReminderMessage('Do≈°lo je do gre≈°ke u zakazivanju: ' + error.message, false);
        }
      });
    }

    function validateReminderInputs(data) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const phoneRegex = /^\+[0-9]{10,15}$/;

      // Check if scheduled time is in the future
      const now = new Date();
      const scheduledTime = new Date(data.scheduleTime);
      if (scheduledTime <= now) {
        showReminderMessage('Vrijeme slanja mora biti u buduƒánosti!', false);
        return false;
      }

      if (data.channel === 'email' && !emailRegex.test(data.recipient)) {
        showReminderMessage('Unesite valjanu e-mail adresu', false);
        return false;
      }

      if (data.channel === 'whatsapp' && !phoneRegex.test(data.recipient)) {
        showReminderMessage('Unesite valjani WhatsApp broj u formatu +385...', false);
        return false;
      }

      return true;
    }

    function scheduleReminder(reminderData) {
      const scheduledTime = new Date(reminderData.scheduleTime).getTime();
      const now = new Date().getTime();
      const delay = scheduledTime - now;

      // Store reminder in localStorage
      const reminder = {
        ...reminderData,
        id: Date.now().toString(),
        scheduledTime: scheduledTime,
        type: 'reminder' // Dodajemo tip kako bismo ga razlikovali
      };
      
      scheduledReminders.push(reminder);
      localStorage.setItem('scheduledReminders', JSON.stringify(scheduledReminders));
      
      // DODANO: Snimi podsjetnik u kalendar
      reminders.push({
        id: reminder.id,
        title: reminderData.title,
        message: reminderData.message,
        date: reminderData.scheduleTime, // Koristimo scheduleTime kao datum
        type: 'reminder',
        channel: reminderData.channel,
        recipient: reminderData.recipient
      });
      localStorage.setItem('reminders', JSON.stringify(reminders));
      
      // A≈æuriraj prikaz kalendara
      generateCalendar();

      // Set timeout for the reminder
      setTimeout(() => {
        sendReminder(reminder);
        // Remove from scheduled reminders after sending
        scheduledReminders = scheduledReminders.filter(r => r.id !== reminder.id);
        localStorage.setItem('scheduledReminders', JSON.stringify(scheduledReminders));
      }, delay);
    }

    // DODANO: Pobolj≈°ana funkcija za slanje WhatsApp poruka
    async function sendReminder(reminder) {
      try {
        if (reminder.channel === 'whatsapp') {
          // Koristimo CallMeBot API za slanje WhatsApp poruka
          const phone = reminder.recipient.replace('+', '');
          const text = encodeURIComponent(`${reminder.title}\n\n${reminder.message}`);
          
          // Ako je dostupan API kljuƒç, koristimo ga
          let apiUrl;
          if (reminder.whatsappApiKey) {
            apiUrl = `https://api.callmebot.com/whatsapp.php?phone=${phone}&text=${text}&apikey=${reminder.whatsappApiKey}`;
          } else {
            // Default API za testiranje (mo≈æe zahtijevati ruƒçnu potvrdu)
            apiUrl = `https://api.callmebot.com/whatsapp.php?phone=${phone}&text=${text}`;
          }
          
          await fetch(apiUrl);
          console.log('WhatsApp reminder sent successfully');
        } else {
          await Email.send({
            Host: "smtp.gmail.com",
            Username: "planedme@gmail.com",
            Password: "eqkm gain qqyz udqn",
            To: reminder.recipient,
            From: "planedme@gmail.com",
            Subject: reminder.title,
            Body: reminder.message
          });
          console.log('Email reminder sent successfully');
        }
      } catch (error) {
        console.error('Error sending reminder:', error);
      }
    }

    function checkScheduledReminders() {
      const now = new Date().getTime();
      const remindersToRemove = [];

      scheduledReminders.forEach((reminder, index) => {
        if (reminder.scheduledTime <= now) {
          // This reminder should have been sent already
          sendReminder(reminder);
          remindersToRemove.push(index);
        }
      });

      // Remove sent reminders
      remindersToRemove.reverse().forEach(index => {
        scheduledReminders.splice(index, 1);
      });

      if (remindersToRemove.length > 0) {
        localStorage.setItem('scheduledReminders', JSON.stringify(scheduledReminders));
      }
    }

    function showReminderMessage(text, isSuccess) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = text;
      statusDiv.className = isSuccess ? 'success' : 'error';
      
      setTimeout(() => {
        statusDiv.textContent = '';
        statusDiv.className = '';
      }, 5000);
    }

    // Eksport detalja
    function exportDetailsCSV() {
      const date = selectedDate;
      const dateStr = date.toDateString();
      let csvContent = "data:text/csv;charset=utf-8,Tip,Opis,Datum,Kanal\n"; // DODANO kolona

      tasks.filter(t => new Date(t.date).toDateString() === dateStr)
           .forEach(t => {
             csvContent += `Zadatak,"${t.title.replace(/"/g, '""')}",${t.date},\n`;
      });

      notes.filter(n => new Date(n.date).toDateString() === dateStr)
           .forEach(n => {
             csvContent += `Bilje≈°ka,"${n.text.replace(/"/g, '""')}",${n.date},\n`;
      });

      // DODANO: Podsjetnici
      reminders.filter(r => new Date(r.date).toDateString() === dateStr)
               .forEach(r => {
                 csvContent += `Podsjetnik,"${r.title.replace(/"/g, '""')}",${r.date},${r.channel}\n`;
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.href = encodedUri;
      link.download = `detalji_${date.toISOString().split('T')[0]}.csv`;
      link.click();
    }

    function exportDetailsJSON() {
      const date = selectedDate;
      const details = {
        date: date.toISOString(),
        tasks: tasks.filter(t => new Date(t.date).toDateString() === date.toDateString()),
        notes: notes.filter(n => new Date(n.date).toDateString() === date.toDateString()),
        reminders: reminders.filter(r => new Date(r.date).toDateString() === date.toDateString()) // DODANO
      };
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(details, null, 2));
      const link = document.createElement('a');
      link.href = dataStr;
      link.download = `detalji_${date.toISOString().split('T')[0]}.json`;
      link.click();
    }

    // Animacija vatrometa
    function showFireworks() {
      const duration = 2000;
      const animationEnd = Date.now() + duration;
      const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 2000 };
      
      function randomInRange(min, max) {
        return Math.random() * (max - min) + min;
      }
      
      const interval = setInterval(function() {
        const timeLeft = animationEnd - Date.now();
        
        if (timeLeft <= 0) {
          return clearInterval(interval);
        }
        
        const particleCount = 50 * (timeLeft / duration);
        
        confetti({
          ...defaults,
          particleCount,
          origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
        });
        
        confetti({
          ...defaults,
          particleCount,
          origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
        });
      }, 250);
    }

    // Zatvaranje modala
    function closeModals() {
      document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
      document.getElementById('overlay').classList.remove('show');
      
      // DODANO: Zaustavi audio pri zatvaranju modala
      if (isPlaying) {
        speechSynthesis.cancel();
        isPlaying = false;
        isPaused = false;
      }
    }

    // Pomoƒáne funkcije
    function showCalendar() {
      closeModals();
    }
  </script>
</body>
</html>